<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="bower_components/geo-location/geo-location.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/maps-icons.html">
<link rel="import" href="bower_components/iron-icons/device-icons.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-card/paper-card.html">

<dom-module id="positional-search">
<template>
<style>
:host {
  display: inline-block:
}
paper-icon-button {
  opacity: var(--dark-secondary-opacity);
}
input {
  position: relative;
  z-index: 1;
  outline: none;
  border: none;
  @apply(--paper-font-title);
}
</style>

  <template is="dom-if" if="[[active]]">
    <geo-location watchpos></geo-location>
  </template>

  <paper-card class="layout horizontal">
    <paper-icon-button icon="search"></paper-icon-button>
    <input id="input" type="text" placeholder="Search nearby places" on-change="_onInputChange">
    <paper-icon-button icon="clear" on-tap="_clearInput"></paper-icon-button>
    <paper-icon-button icon="{{_computeGPSIcon(active)}}"
          on-tap="getPosition"></paper-icon-button>
  </paper-card>

</template>
<script>
  Polymer({
    is: 'positional-search',
    properties: {
      active: {
        type: Boolean,
        value: false,
        notify: true
      },
      query: {
        type: String,
        value: null,
        notify: true,
      }
    },
    _computeGPSIcon: function(active) {
      return active ? 'device:gps-fixed' : 'device:gps-not-fixed';
    },
    _onInputChange: function(e, detail) {
      this.query = e.target.value;
    },
    _clearInput: function(e, detail) {
      this.$.input.value = null;
    },
    ready: function() {
      this.waitForPosition();
    },
    getPosition: function() {
      this.active = true;
    },
    waitForPosition: function(e, detail) {
      navigator.permissions.query({name: 'geolocation'}).then(function(status) {
        this.active = status.state === 'granted';
        status.onchange = function(e) {
          this.active = status.state === 'granted';
        }.bind(this);
      }.bind(this));
    }
  });
</script>
</dom-module>
